#### 谷粒学院笔记:

##### 阿里云oss存储服务

简述：

为了解决海量数据存储与弹性扩容，项目中我们采用云存储的解决方案- 阿里云OSS。 

- 1、开通对象存储OSS服务
- （1）申请阿里云账号
- （2）实名认证
- （3）开通“对象存储OSS”服务
- （4）进入管理控制台

1、讲师头像上传功能：

###### 搭建oss配置项目

依赖:

```xml
    <dependency>
            <groupId>com.aliyun.oss</groupId>
            <artifactId>aliyun-sdk-oss</artifactId>
        </dependency>
```

配置文件：

```yml
#端口号
server:
  port: 8002
#服务名
spring:
  application:
    name: service-oss
    #环境设置：dev、test、prod
  profiles:
    active: dev
#阿里云 OSS
#不同的服务器，地址不同
aliyun:
  oss:
    file:
      endpoint: xxxx
      keyid: xx
      keysecret: xx
      #bucket可以在控制台创建，也可以使用java代码创建
      bucketname: xxx

```







错误：

```
Description:

Failed to configure a DataSource: 'url' attribute is not specified and no embedded datasource could be configured
```

导入了数据库jar 原因没有配置数据源

spring boot 会默认加载org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration这个类，而DataSourceAutoConfiguration类使用了@Configuration注解向spring注入了dataSource bean，又因为项目（oss模块）中并没有关于dataSource相关的配置信息，所以当spring创建dataSource bean时因缺少相关的信息就会报错

解决方案：

1、配置数据源头

2、在启动类添加注解,默认不去加载数据库配置

##### 实现文件上传

1、从配置文件读取常量

创建常量读取工具类：ConstantPropertiesUtil.java使用@Value读取application.properties里的配置内容 用spring的 InitializingBean 的 afterPropertiesSet 来初始化配置信息，这个方法将在所有的属性被初始化

后调用。

```java
package cn.jinronga.oss.utils;

import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

/**
 * @ClassName ConstantPropertiesUtil
 * @Author 郭金荣
 * @Date 2021/2/28 22:36
 * @Description ConstantPropertiesUtil
 * 常量类，读取配置文件application.properties中的配置
 */
@Component
public class ConstantPropertiesUtil implements InitializingBean {
    @Value("${aliyun.oss.file.endpoint}")
    private String endpoint;

    @Value("${aliyun.oss.file.keyid}")
    private String keyId;

    @Value("${aliyun.oss.file.keysecret}")
    private String keySecret;

    @Value("${aliyun.oss.file.bucketname}")
    private String bucketName;


    // 定义静态常量
    public static String END_POINT;
    public static String ACCESS_KEY_ID;
    public static String ACCESS_KEY_SECRET;
    public static String BUCKET_NAME;

    @Override
    public void afterPropertiesSet() throws Exception {
        END_POINT = endpoint;
        ACCESS_KEY_ID = keyId;
        ACCESS_KEY_SECRET = keySecret;
        BUCKET_NAME = bucketName;
    }
}

```

文件上传service：

```j'a'va
public interface FileService {
    /**
     * 文件上传到阿里云
     * @param file
     * @return
     */
    String upload(MultipartFile file);
}

```



实现：FileServiceImpl.java

参考SDK中的：Java->上传文件->简单上传->流式上传->上传文件流

```java
public class FileServiceImpl implements FileService {
    @Override
    public String upload(MultipartFile file) {
        
        // Endpoint以杭州为例，其它Region请按实际情况填写。
        String endpoint = ConstantPropertiesUtil.END_POINT;
        // 云账号AccessKey有所有API访问权限，建议遵循阿里云安全最佳实践，创建并使用RAM子账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建。
        String accessKeyId = ConstantPropertiesUtil.ACCESS_KEY_ID;
        String accessKeySecret = ConstantPropertiesUtil.ACCESS_KEY_SECRET;
        String backetName = ConstantPropertiesUtil.BUCKET_NAME;
        

        try {
            // 创建OSSClient实例。
            OSS ossClient = new OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);
            // 获取上传文件的输入流
            InputStream inputStream = file.getInputStream();

            // 获取文件名称
            String filename = file.getOriginalFilename();
            // 1. 在文件名称中添加随机的唯一的值，防止名称一样时文件的覆盖
            String uuid = UUID.randomUUID().toString().replaceAll("-","");
            filename = uuid + filename;

            // 2. 把文件安装日期进行分类，会自动创建文件夹
            // 获取当前的日期
            String datePath = new DateTime().toString("yyyy/MM/dd");
            filename = datePath + "/" + filename;
            

            // 调用oss方法实现上传
            // 第一个参数 Bucket名称
            // 第二个参数 上传到oss文件的路径和文件名称
            // 输入流
            ossClient.putObject(backetName, filename, inputStream);
            
            // 关闭OSSClient。
            ossClient.shutdown();

            // 上传文件之后的路径，需要自己拼接
            String url = "https://"+backetName+"."+endpoint+"/"+filename;

            //https://edu-pony.oss-cn-beijing.aliyuncs.com/2020/12/21/c382358e1e4340eca6957eee10fe5a7f01.jpg
            return url;

        } catch (IOException e) {
            e.printStackTrace();
            return null;
        }

    }
}
```

3、控制层

创建controller：FileUploadController.java







2、添加课程分类功能

- 1.使用EasyExcel读取excel内容添加数据







3、课程分类列表

（1）树形结构显示

